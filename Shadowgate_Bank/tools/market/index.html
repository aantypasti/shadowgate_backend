<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Market • Shadowgate Bank</title>

  <style>
    :root{ --bg:#1e1e1e; --panel:#2a2a2a; --border:#333; --text:#e6e6e6; --muted:#aeb4bb; --brand:#36b0ff; --radius:14px; --maxw:1200px; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font-family: 'Poppins', system-ui, Arial, sans-serif }
    a{ color:var(--brand); text-decoration:none } a:hover{text-decoration:underline}
    .wrap{ max-width:var(--maxw); margin:0 auto; padding:0 16px }

    /* Header */
    header{ background:var(--panel); border-bottom:1px solid var(--border) }
    .header-bar{ display:flex; align-items:center; justify-content:center; position:relative; min-height:92px }
    .logo-left{ position:absolute; left:16px; display:flex; align-items:center }
    .logo-left img{ height:74px; width:auto; object-fit:contain }
    .site-title{ font-size:26px; font-weight:800; margin:0 }
    .header-actions{ position:absolute; right:16px; display:flex; gap:10px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:8px 14px; border:1px solid var(--border); background:#222; color:var(--text); border-radius:10px; font-weight:600 }
    .btn.primary{ border-color:var(--brand) } .btn:hover{ background:#242424 }

    /* Layout */
    main{ padding:22px 0 }
    .grid{ display:grid; grid-template-columns: 1.6fr 0.9fr; gap:16px }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    .panel{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:14px }
    .row{ display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:end }
    label{ display:block; font-size:13px; color:#cfd3d8; margin-bottom:4px }
    input, select{ width:100%; padding:9px 10px; border-radius:10px; border:1px solid var(--border); background:#1a1a1a; color:var(--text) }
    .muted{ color:var(--muted) }

    /* Chart area */
    #chartWrap{ background:#1b1b1b; border:1px solid var(--border); border-radius:10px; padding:8px; height:420px; display:flex; flex-direction:column }
    #chartCanvas{ flex:1; width:100% }

    /* Ticker list */
    .tickers{ background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); padding:0 }
    .tickers h3{ margin:12px 12px 6px; font-size:18px }
    .list{ max-height:520px; overflow:auto; padding:6px 8px }
    .item{ display:flex; justify-content:space-between; gap:8px; padding:10px 8px; border-radius:8px; cursor:pointer }
    .item:hover{ background:#262626 }
    .sym{ font-weight:700 }
    .price{ color:#d8dee5 }
    .chg.up{ color:#71d08a } .chg.down{ color:#ff7b7b }
  </style>

  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="wrap">
      <div class="header-bar">
        <div class="logo-left">
          <a href="../../"><img src="Shadowgate_Logo.png" alt="Shadowgate Bank">
</a>
        </div>
        <h1 class="site-title">SG1 Exchange</h1>
        <div class="header-actions">
          <a class="btn" href="../">Tools</a>
          <a class="btn" href="../../about/">About</a>
          <a class="btn" href="../../login/">Log In</a>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- Left: chart + controls -->
      <section class="panel">
        <div class="row">
          <div>
            <label for="ticker">Ticker</label>
            <input id="ticker" placeholder="e.g., SG1:FIOC or FUT:LI-2025W32" />
          </div>
          <div>
            <label for="span">Timespan</label>
            <select id="span">
              <option value="1d">1D</option>
              <option value="1w" selected>1W</option>
              <option value="1m">1M</option>
              <option value="3m">3M</option>
              <option value="1y">1Y</option>
            </select>
          </div>
          <div>
            <button id="loadBtn" class="btn primary" style="margin-top:22px">Load</button>
          </div>
        </div>

        <div id="chartWrap" style="margin-top:10px">
          <canvas id="chartCanvas"></canvas>
          <div id="chartHint" class="muted" style="font-size:12px; margin-top:6px">
            Demo line chart with mock data. Switch to API later by changing one flag in the script.
          </div>
        </div>
      </section>

      <!-- Right: list of tickers -->
      <aside class="tickers">
        <h3>List of Tickers</h3>
        <div id="tickerList" class="list"></div>
      </aside>
    </div>
  </main>

  <script>
    /* =========================
       ADAPTER TOGGLE (one line)
       =========================
       Use 'mock' now; change to 'api' when your caching API is ready.
    */
    const DATA_SOURCE = 'mock'; // 'mock' | 'api'

    /* =========================
       API Endpoints (back-end)
       =========================
       When switching to 'api', set BASE like:
         const BASE = 'https://your-proxy.example.com/api/market';
       Expected JSON:
         GET ${BASE}/summary          -> { instruments:[{symbol,last,change24h}], ts }
         GET ${BASE}/candles?symbol=…&span=1w
           -> { symbol, span, candles:[{t, o, h, l, c, v}] }
    */
    const BASE = '/api/market'; // placeholder; won’t be called in mock mode

    /* =========================
       Adapters
       ========================= */
    const MockAdapter = {
      async summary(){
        const syms = ['SG1:FIOC','SG1:BEN','FUT:LI-2025W32','FUT:CU-2025W20','FUT:BCO-2025W18'];
        return {
          instruments: syms.map((s,i)=>({
            symbol: s,
            last: +(100 + i*7 + Math.random()*8).toFixed(2),
            change24h: +( (Math.random()*4-2).toFixed(2) )
          })),
          ts: Date.now()
        };
      },
      async candles(symbol, span){
        // Produce deterministic-ish mock candles
        const n = ({'1d':24, '1w':7*24, '1m':30*24, '3m':90*24, '1y':365*24})[span] || 7*24;
        let t = Date.now() - n*3600*1000;
        let v = 100 + Math.random()*20;
        const arr = [];
        for(let i=0;i<n;i++){
          const drift = (Math.sin(i/17)+Math.cos(i/9))*0.2;
          const noise = (Math.random()-0.5)*0.8;
          const o = v;
          v = Math.max(1, v + drift + noise);
          const c = v;
          const h = Math.max(o,c) + Math.random()*0.6;
          const l = Math.min(o,c) - Math.random()*0.6;
          arr.push({ t, o:+o.toFixed(2), h:+h.toFixed(2), l:+l.toFixed(2), c:+c.toFixed(2), v: Math.round(100+Math.random()*900) });
          t += 3600*1000;
        }
        return { symbol, span, candles: arr };
      }
    };

    const ApiAdapter = {
      async summary(){
        const r = await fetch(`${BASE}/summary`, { headers:{ 'accept':'application/json' }});
        return r.json();
      },
      async candles(symbol, span){
        const r = await fetch(`${BASE}/candles?symbol=${encodeURIComponent(symbol)}&span=${span}`, { headers:{ 'accept':'application/json' }});
        return r.json();
      }
    };

    const Data = (DATA_SOURCE === 'api') ? ApiAdapter : MockAdapter;

    /* =========================
       UI Wiring
       ========================= */
    const listEl   = document.getElementById('tickerList');
    const inputEl  = document.getElementById('ticker');
    const spanEl   = document.getElementById('span');
    const loadBtn  = document.getElementById('loadBtn');
    const canvas   = document.getElementById('chartCanvas');
    const ctx      = canvas.getContext('2d');

    async function loadSummary(){
      const s = await Data.summary();
      renderList(s.instruments);
    }

    function renderList(items){
      listEl.innerHTML = '';
      items.forEach(it=>{
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div class="sym">${it.symbol}</div>
          <div class="price">${it.last.toFixed ? it.last.toFixed(2) : it.last}</div>
          <div class="chg ${it.change24h>=0?'up':'down'}">${(it.change24h>=0?'+':'')}${it.change24h.toFixed ? it.change24h.toFixed(2) : it.change24h}%</div>
        `;
        row.addEventListener('click', ()=>{
          inputEl.value = it.symbol;
          loadChart();
        });
        listEl.appendChild(row);
      });
    }

    async function loadChart(){
      const symbol = (inputEl.value || '').trim() || 'SG1:FIOC';
      const span   = spanEl.value || '1w';
      const data   = await Data.candles(symbol, span);
      drawLineChart(data.candles);
    }

    function drawLineChart(candles){
      // Resize canvas to parent
      const box = canvas.parentElement.getBoundingClientRect();
      canvas.width = Math.floor(box.width - 4);
      canvas.height = Math.floor(box.height - 40);

      ctx.clearRect(0,0,canvas.width,canvas.height);
      if (!candles || candles.length === 0) return;

      // Compute bounds
      const xs = candles.map((_,i)=>i);
      const ys = candles.map(d=>d.c);
      const min = Math.min(...ys), max = Math.max(...ys);
      const pad = (max-min)*0.1 || 1;
      const lo = min - pad, hi = max + pad;

      // Helpers
      const x = i => (i / (xs.length-1)) * (canvas.width - 20) + 10;
      const y = v => canvas.height - ((v - lo) / (hi - lo)) * (canvas.height - 20) - 10;

      // Axis (light)
      ctx.strokeStyle = '#3a3a3a'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(8, 10); ctx.lineTo(8, canvas.height-10); ctx.lineTo(canvas.width-10, canvas.height-10); ctx.stroke();

      // Line
      ctx.strokeStyle = '#36b0ff'; ctx.lineWidth = 2; ctx.beginPath();
      candles.forEach((d,i)=>{ const px=x(i), py=y(d.c); if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py); });
      ctx.stroke();

      // Last price label
      const last = candles[candles.length-1]?.c;
      ctx.fillStyle = '#cfd3d8'; ctx.font = '12px Poppins';
      ctx.fillText(`Last: ${last}`, 16, 20);
    }

    // Events
    loadBtn.addEventListener('click', loadChart);
    spanEl.addEventListener('change', loadChart);

    // Init
    loadSummary().then(loadChart);

    // Optional polling (only if using API)
    if (DATA_SOURCE === 'api') {
      setInterval(()=>{
        loadChart();
        loadSummary();
      }, 5000); // 5s
    }
  </script>
</body>
</html>

